<!DOCTYPE html>
<html style="margin: 0px; width: 100%; height: 100%;" prefix="og: http://ogp.me/ns#">
<head>

  <title>POIJU.IO - Ilmaiset merikartat koko Suomen alueelle</title>
  <meta property="og:title" content="POIJU.IO" />
  <meta property="og:description" content="POIJU.IO - Ilmaiset merikartat koko Suomen alueelle. Toimii myös mobiililaitteilla home screenille asennettuna webappina!" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.poiju.io/" />
  <meta property="og:image" content="http://www.poiju.io/poiju-logo.png" />
  <meta property="og:image:secure_url" content="https://www.poijuio.com/poiju-logo.png" />
  <meta property="fb:app_id" content="1217568344949951" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <meta charset="utf-8" />

  <meta name="viewport" content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
  <script>
  <% include ../js/mapbox-gl.js %>
  <% include ../js/spin.min.js %>
  </script>

  <!-- Favicons start -->

  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/manifest.json">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- Favicons end -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="POIJU.IO">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta name="mobile-web-app-capable" content="yes">


  <link href='stylesheets/mapbox-gl.css' rel='stylesheet' />
  <link href='stylesheets/addtohomescreen.css' rel='stylesheet' />
  <link href='stylesheets/main.css' rel='stylesheet' />
  <link href='components/bootstrap/dist/css/bootstrap.min.css' rel='stylesheet' />
  <link href='components/sidr/dist/stylesheets/jquery.sidr.dark.min.css' rel='stylesheet' />
  <link href='components/bootstrap-switch/dist/css/bootstrap3/bootstrap-switch.min.css' rel='stylesheet' />
  <link href='stylesheets/tether.min.css' rel='stylesheet' />
  <link href='stylesheets/mapbox-gl-geocoder.css' rel='stylesheet' />
  <script src="js/addtohomescreen.js"></script>
  <script src="components/local-storage-js/storage.min.js"></script>
  <script src="components/jquery/dist/jquery.min.js"></script>
  <script src="components/sidr/dist/jquery.sidr.min.js"></script>
  <script src="js/tether.min.js"></script>
  <script src="components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="components/bootstrap-switch/dist/js/bootstrap-switch.min.js"></script>
  <script src='js/mapbox-gl-geocoder.js'></script>

  <script>

  // SETTINGS:
  var defaultLocation = [ 23.772788 , 61.509346 ]
  var locationUpdateInterval = 5000;
  var maxBounds = [
    [ 18.708052 , 58.714757 ], // Southwest coordinates
    [ 31.847700 , 70.343238 ]  // Northeast coordinates
  ];

  // Try to avoid crashing:
  var minZoom = 10;

  mapboxgl.accessToken = 'pk.eyJ1IjoibWlsa2FuZGNyZWFtIiwiYSI6ImNpb3dxcHZzazAwOWJ3OWtqNHNjdTgzNjMifQ.KK7QXbd-tSQzfH96p9rpPg';


  addToHomescreen({
    modal: 1,
   skipFirstVisit: true,
   maxDisplayCount: 5,
   startDelay: 5
  });

  // Update location is on by default:
  if ( localStorage.getItem('updateLoc') !== 'false' ) {
    localStorage.setItem('updateLoc', 'true')
  }
  </script>
</head>
<body style="margin: 0px; width: 100%; height: 100%; -moz-user-select: none; -webkit-user-select: none; -ms-user-select:none; user-select:none;-o-user-select:none;" 
 unselectable="on"
 onselectstart="return false;" >
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5S5TFX"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5S5TFX');</script>
<!-- End Google Tag Manager -->

  <div id="map" style="margin: 0px; width: 100%; height: 100%;"></div>
  
  <!-- Splash screen -->
  <div id="splash-screen" style="margin: 0px; width: 100%; height: 100%; z-index: 2;  background: black; top: 0; left: 0; position: absolute;">
    <div style="display:flex;justify-content:center;align-items:center;">
      <div style="width:320px;height:460px;"><img src="/poiju-splash.png"/></div>
    </div>
  </div>

  <button type="button" class="btn btn-secondary" style="top: 0; left: 0; position: absolute; margin: 10px 0 0 10px" id="side-menu"><img width="20" src="images/menu.png"/></button>

  <div class="alert alert-warning alert-dismissible fade in" id="disclaimer" role="alert" style="top: 0; left: 0; position: absolute;">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
    <strong>Tervetuloa POIJU.IO appiin!</strong> Muistathan, että tämä sovellus on kehitysvaiheessa eikä sovellu turvalliseen navigointiin. Datasta puuttuvat esimerkiksi kivien karttamerkit, joten vältä erityisesti matalikkoja ja tarkista aina reittivalintasi virallisesta merikartasta.
  </div>

  <div id="sidr" style="z-index: 1; overflow: auto;">
    <!-- Your content -->
    <div style="background-color: black">
      <img style="margin: 0 0 0 0; top: 0 " width="260" src="poiju-logo-menu.png">
    </div>
    
    <div>
      <div id="searchLocation" />
    </div>

    <ul>
      <li><a onClick="alert('Long: ' + localStorage.getItem( 'lastLong' ) + '\nLat: ' + localStorage.getItem( 'lastLat' ) );">Sijainti</a></li>
      <li><a onClick="alert( 'The MIT License (MIT)\n\nCopyright (c) 2016 POIJU.IO\n\nhttps://github.com/iaue/poiju.io\n\nKartta-aineiston lähteet:\nLiikennevirasto 06/2016. Ei navigointikäyttöön. Ei täytä virallisen merikartan vaatimuksia.\nMaanmittauslaitoksen Maastotietokanta 06/2016\n' );">Lisenssitiedot</a></li>
    </ul>

    <div style='margin: 10px 15px 0 15px;'>
      <table>
        <tr><td colspan="2"><strong>Merimerkit:</strong></td></tr>
        <tr>
          <td width="40" align="center"  ><img src="diagrams/NChart_ECDIS_Cardinal_simple_Beacon_N.svg" width="20"/></td><td>Pohjoisviitta</td>
        </tr>
        <tr>
          <td width="40" align="center" ><img src="diagrams/NChart_ECDIS_Cardinal_simple_Beacon_S.svg" width="20"/></td><td>Eteläviitta</td>
        </tr>
        <tr>
          <td width="40" align="center" ><img src="diagrams/NChart_ECDIS_Cardinal_simple_Beacon_E.svg" width="20"/></td><td>Itäviitta</td>
        </tr>
        <tr>
          <td width="40" align="center" ><img src="diagrams/NChart_ECDIS_Cardinal_simple_Beacon_W.svg" width="20"/></td><td>Länsiviitta</td>
        </tr>
        <tr>
          <td width="40" align="center" ><span style="color: green;" width="20">•</span></td><td>Oikea</td>
        </tr>
        <tr>
          <td width="40" align="center" ><span style="color: red;" width="20">•</span></td><td>Vasen</td>
        </tr>
        <tr>
          <td width="40" align="center" ><img src="diagrams/lighthouse-15.svg" width="20"/></td><td>Loisto</td>
        </tr>
        <tr>
          <td width="40" align="center" ><img src="diagrams/NChart_ECDIS_IsolatedDanger_simple_Beacon.svg" width="20"></td><td>Karimerkki</td>
        </tr>
        <tr>
          <td width="40" align="center"><img src="diagrams/rock-cross.svg" width="20" ></td><td>Kivi <strong style="font-size: 0.7em">(vain Tampere - Virrat)</strong></td>
        </tr>
        <tr>
          <td width="40" align="center" ><img src="diagrams/monument-15.svg" width="20"></td><td>Kummeli</td>
        </tr>
      </table>
    </div>
    <div class="rocksDisclaimer"><p><strong>Huom:</strong> karttaan ei ole merkitty kaikkia yksittäisiä kiviä - tarkista kivien sijainti merikartasta.</p></div>

    <div style='margin: 10px 15px 0 15px;'>
      <table>
        <tr><td colspan="2"><strong>Paikannusasetukset:</strong></td></tr>
        <tr>
          <td>Päivitä:</td><td align="right"><input type="checkbox" name="update-location"/></td>
        </tr>

        <tr>
          <td>Seuraa:</td><td align="right"><input type="checkbox" name="follow-location"/></td>
        </tr>
      </table>
    </div>
    <div style='margin: 30px 15px 0 15px;'>
      <a href="https://go.taplause.com/BkyuTguL" style="color: grey;" target="_blank">Anna palautetta</a>
    </div>
    <div style="padding-bottom: 80px"/>
  </div>

  <!-- Add swipe control to menu -->
  <script src="//cdn.jsdelivr.net/jquery.touchswipe/1.6.15/jquery.touchSwipe.min.js"></script>
  <script>
  $('#sidr').swipe( {
      //Single swipe handler for left swipes
      swipeLeft: function () {
          $.sidr('close', 'sidr');
      },
      //Default is 75px, set to 0 for demo so any distance triggers swipe
      threshold: 45,

      allowPageScroll:"vertical"
  });
  </script>

  <script>
  $(document).ready(function() {
    $('#side-menu').sidr( { onCloseEnd : resetMenuScroll } );
  });

  // Reset scroll on menu - currently not working:
  function resetMenuScroll() {
    $('#sidr').scrollTop();
  }

  $("[name='update-location']").bootstrapSwitch({size: 'mini', state : localStorage.getItem('updateLoc') === 'true' ? true : false , onSwitchChange : updateLocSetting });
  $("[name='follow-location']").bootstrapSwitch({size: 'mini', state : localStorage.getItem('followLoc') === 'true' ? true : false , onSwitchChange : followLocSetting });

  function updateLocSetting( event, state ) {
    localStorage.setItem( 'updateLoc' , state );
  }

  function followLocSetting( event, state ) {
    localStorage.setItem( 'followLoc' , state );
    console.log( state )
  }

  </script>

  <script>

  /* Spinner start */
  var opts = {
      lines: 12 // The number of lines to draw
    , length: 26 // The length of each line
    , width: 12 // The line thickness
    , radius: 40 // The radius of the inner circle
    , scale: 0.5 // Scales overall size of the spinner
    , corners: 1 // Corner roundness (0..1)
    , color: '#fff' // #rgb or #rrggbb or array of colors
    , opacity: 0.25 // Opacity of the lines
    , rotate: 0 // The rotation offset
    , direction: 1 // 1: clockwise, -1: counterclockwise
    , speed: 1 // Rounds per second
    , trail: 60 // Afterglow percentage
    , fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
    , zIndex: 3 // The z-index (defaults to 2000000000)
    , className: 'spinner' // The CSS class to assign to the spinner
    , top: '50%' // Top position relative to parent
    , left: '50%' // Left position relative to parent
    , shadow: true // Whether to render a shadow
    , hwaccel: false // Whether to use hardware acceleration
    , position: 'absolute' // Element positioning
  }

  var target = document.getElementById('map')
  var spinner = new Spinner(opts).spin(target);
  /* Spinner end */

  //localStorage.clear()
  // Close the disclaimer in case it has been shown:
  if ( localStorage.getItem( "disclaimerShown" ) === "true" )
  {
    $(".alert").alert('close')
  }

  //localStorage.clear()

  $("#disclaimer").on('close.bs.alert', function () {
    console.log( "closed" )
    localStorage.setItem( "disclaimerShown", "true" )
  })

  var mapInitialized = false;

  // Init position from last location:
  var initialPosition = [ localStorage.getItem('lastLong') || defaultLocation[0] , localStorage.getItem('lastLat') || defaultLocation[1] ];

  var map = new mapboxgl.Map({
      attributionControl : false,
      container: 'map',
      style: 'mapbox://styles/milkandcream/ciq5uxcra005nq7ndrm766s76',
      center: initialPosition,
      zoom: 12,
      maxBounds: maxBounds,
      minZoom: minZoom
  });

  // Update marker position and map center:
  function updateMarkerPosition( coordinates ) {
    localStorage.setItem( 'lastLong', coordinates[0] )
    localStorage.setItem( 'lastLat', coordinates[1] )

    // Center map on first load:
    if ( !mapInitialized )
    {
      map.setCenter( coordinates )
      mapInitialized = true;
    }

    if ( localStorage.getItem('followLoc') === 'true'  )
    {
      map.flyTo({
          center: coordinates,
          options: { curve : 0.01, speed: 0.1}
      });
    }

    map.getSource('boat').setData( {
                  "type": "Feature",
                  "geometry": {
                      "type": "Point",
                      "coordinates": coordinates
                  },
                  "properties": {
                      "title": "",
                      "marker-symbol": "ferry-15"
                  }
              } )
  }

  // Set error marker on map if geolocation fails:
  function locationErrorMarker() {
    var pos = [ localStorage.getItem('lastLong') || defaultLocation[0] , localStorage.getItem('lastLat') || defaultLocation[1] ]
    
    map.getSource('boat').setData( {
                  "type": "Feature",
                  "geometry": {
                      "type": "Point",
                      "coordinates": pos
                  },
                  "properties": {
                      "title": "",
                      "marker-symbol": "cross-11"
                  }
              } )
  }

  // Get new geolocation:
  function updateLocation() {

    navigator.geolocation.getCurrentPosition(function(position) {
      pos = [ position.coords.longitude, position.coords.latitude ];

      // Update boat marker position on map:
      updateMarkerPosition( pos );
      spinner.stop();

      var elem = document.getElementById("splash-screen");
      if ( elem ) {
        elem.remove();
      }
    }, function() {
      handleLocationError(true);
    },
    {
      enableHighAccuracy: true
    });
  }
  
  // Error handling if geolocation fails:
  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    locationErrorMarker()
    console.log(browserHasGeolocation ?
                          'Error: The Geolocation service failed.' :
                          'Error: Your browser doesn\'t support geolocation.');
    spinner.stop();

    var elem = document.getElementById("splash-screen");
    if ( elem ) {
      elem.remove();
    }
  }

  map.addControl(new mapboxgl.Navigation({position: 'top-right'}));
  var geoLocateControl = new mapboxgl.Geolocate({position: 'bottom-left'});
  geoLocateControl.on( 'geolocate' , function(data) { updateLocation( [ data.coords.longitude , data.coords.latitude ])})
  map.addControl( geoLocateControl );

  var geoCoderControl = new mapboxgl.Geocoder({ placeholder: 'Etsi kohdetta', container: document.getElementById('searchLocation'), country: 'fi', types: 'region,postcode,place,locality,neighborhood,address'})
  map.addControl( geoCoderControl );

  map.on('load', function () {

    var pos = [ localStorage.getItem('lastLong') || defaultLocation[0] , localStorage.getItem('lastLat') || defaultLocation[1] ];

    map.addSource("boat", {
        "type": "geojson",
        "data": {
          "type": "Feature",
          "geometry": {
              "type": "Point",
              "coordinates": pos
          },
          "properties": {
              "title": "",
              "marker-symbol": "cross-15"
          }
        }
    });

    map.addLayer({
        "id": "boat",
        "type": "symbol",
        "source": "boat",
        "layout": {
            "icon-image": "{marker-symbol}",
            "text-field": "{title}",
            "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
            "text-offset": [0, 0.6],
            "text-anchor": "top"
        }
    });

    // Try HTML5 geolocation:
    if (navigator.geolocation) {

      // Load initial location:
      updateLocation();

      // Set interval for updating marker position:
      window.setInterval(function() {
          
          if ( localStorage.getItem('updateLoc') === 'true' ) {
            updateLocation();
          }

          else {
            locationErrorMarker();
          }

      }, locationUpdateInterval );

    } else {
      // Browser doesn't support Geolocation
      handleLocationError(false);
    }
  });

  </script>

</body>
</html>
